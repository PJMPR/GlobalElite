package dao;

import dao.mappers.IMapResultSetIntoEntity;
import dao.repositories.ITeamRepository;
import dao.uow.IUnitOfWork;
import domain.model.Team;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.List;

/**
 * @author L on 13.11.2016.
 */
public class TeamRepository extends RepositoryBase<Team> implements ITeamRepository {


    private PreparedStatement getName;
    private PreparedStatement getCountry;
    private PreparedStatement getLastId;

    public TeamRepository(Connection connection, IMapResultSetIntoEntity<Team> mapper, IUnitOfWork uow) {
        super(connection, mapper, uow);

        try {
            getName = connection.prepareStatement(getNameSql());
            getCountry = connection.prepareStatement(getCountrySql());
            getLastId = connection.prepareStatement(getLastIdSql());
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }



    protected String getLastIdSql() {
        return "UPDATE TEAM SET(TEAM_STATS_ID) = (SELECT max(id) from TEAM_STATS) where id = (SELECT max(id) FROM TEAM)";
    }

    protected String getNameSql() {
        return "SELECT * FROM TEAM where name = ?";
    }

    protected String getCountrySql() {
        return "SELECT * FROM TEAM where country = ?";
    }


    protected String insertSql() {
        return "INSERT INTO TEAM(name, country) values (?, ?)";
    }

    protected String updateSql() {
        return "UPDATE TEAM SET (name, country, TEAM_STATS_ID) = (?,?,?) where id=?";
    }

    protected void setUpdate(Team team) throws SQLException {
        update.setString(1, team.getName());
        update.setString(2, team.getCountry());
        update.setInt(3, team.getTeamStatistics().getId());
    }

    protected void setInsert(Team team) throws SQLException {
        insert.setString(1, team.getName());
        insert.setString(2, team.getCountry());

        ResultSet gen = insert.getGeneratedKeys();
        if (gen.next()) {
            team.setId(gen.getInt(1));
        }
    }

    @Override
    public void getLastIdForForeignKey() {

        try {
            getLastId.executeUpdate();

        } catch (SQLException e) {
            e.printStackTrace();
        }

    }

    @Override
    public List<Team> withName(String name) {
        return searchByString(name, getName);
    }

    @Override
    public List<Team> withCountry(String country) {
        return searchByString(country, getCountry);
    }


    @Override
    protected String createTableSql() {
        return "" + "CREATE TABLE TEAM("
                + "id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,"
                + "name varchar(25),"
                + "country varchar(25),"
                + "TEAM_STATS_ID int,"
                + "FOREIGN KEY (TEAM_STATS_ID) REFERENCES TEAM_STATS(id)"
                + ")";
    }

    @Override
    protected String tableName() {
        return "TEAM";
    }
}
